name: Weekly Listing Expansion

on:
  schedule:
    # Run every Monday at 6am UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      category:
        description: 'Category to expand'
        required: false
        default: 'coworking'
        type: choice
        options:
          - coworking
          - grant
          - accelerator
          - sba
      limit:
        description: 'Limit per city'
        required: false
        default: '50'
        type: string
      min_listings:
        description: 'Min listings threshold for auto mode'
        required: false
        default: '5'
        type: string

jobs:
  expand-listings:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Step 1: Run Outscraper API expansion
      - name: Expand listings via Outscraper API
        env:
          OUTSCRAPER_API_KEY: ${{ secrets.OUTSCRAPER_API_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          CATEGORY="${{ github.event.inputs.category || 'coworking' }}"
          LIMIT="${{ github.event.inputs.limit || '50' }}"
          MIN_LISTINGS="${{ github.event.inputs.min_listings || '5' }}"

          echo "Running expansion for category: $CATEGORY"
          echo "Limit per city: $LIMIT"
          echo "Min listings threshold: $MIN_LISTINGS"

          npx tsx scripts/outscraper-api-expand.ts \
            --category="$CATEGORY" \
            --cities=auto \
            --limit="$LIMIT" \
            --min-listings="$MIN_LISTINGS"

      # Step 2: Enrich new listings with AI content
      - name: Enrich new listings with AI content
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          CATEGORY="${{ github.event.inputs.category || 'coworking' }}"

          echo "Enriching new listings for category: $CATEGORY"

          npx tsx scripts/enrich-content-seo.ts \
            --mode=listings \
            --category="$CATEGORY" \
            --batch-size=50

      # Step 3: Recalculate location counts
      - name: Recalculate location counts
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: npx tsx scripts/recalc-location-counts.ts

      # Step 4: Submit new URLs to search engines
      - name: Submit URLs to IndexNow
        env:
          INDEXNOW_API_KEY: ${{ secrets.INDEXNOW_API_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: npx tsx scripts/submit-indexnow.ts --listings
